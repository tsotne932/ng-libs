import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
const KEYS = {
    i18n: 'i18n',
    token: 'session-token',
    lang: 'lang',
    clientId: 'clientId',
    appVersions: 'appVersions'
};
export class MsdaStorage {
    constructor(_httpClient) {
        this._httpClient = _httpClient;
        this.applicationAbbrs = [];
        this._token = '';
        this._apiPrefix = '/api';
    }
    /**
     * Load Translations with App abbreviations
     * @param {String} appKeywords[]
     * @param {String} prefix optional parameter
     */
    loadTranslations(appKeywords) {
        return __awaiter(this, void 0, void 0, function* () {
            if (appKeywords && appKeywords.length) {
                this.applicationAbbrs = appKeywords;
                this._checkTranslationVersions();
            }
        });
    }
    /**
     * set clientId to storage
     * @param {number} clientId
     */
    setClientId(clientId, setInSession) {
        return __awaiter(this, void 0, void 0, function* () {
            if (setInSession) {
                try {
                    yield this._setSessionClient(clientId).toPromise();
                    return { success: this._setClientId(clientId) };
                }
                catch (error) {
                    return { success: false, error };
                }
            }
            return { success: this._setClientId(clientId) };
        });
    }
    get clientId() {
        return this._getClientId();
    }
    /**
     * remove clientId
     * @param {number} clientId
     */
    removeClientId() {
        this.setClientId(null);
    }
    _setClientId(clientId) {
        this._clientId = clientId;
        if (clientId)
            localStorage.setItem(KEYS.clientId, clientId.toString());
        else
            localStorage.removeItem(KEYS.clientId);
        return true;
    }
    _getClientId() {
        try {
            this._clientId = Number(localStorage.getItem(KEYS.clientId));
            return this._clientId;
        }
        catch (error) {
            console.error(error);
            return null;
        }
    }
    /**
     * set lang to storage
     * @param {string} lang
     */
    setLang(lang) {
        this._setLang(lang);
    }
    /**
     *  get lang
     */
    static get lang() {
        return localStorage.getItem(KEYS.lang);
    }
    _setLang(lang) {
        if (lang)
            localStorage.setItem(KEYS.lang, lang);
        else
            localStorage.removeItem(KEYS.lang);
    }
    _getLang() {
        return localStorage.getItem(KEYS.lang);
    }
    /**
     * common set item
     * @param {string} key
     * @param {string} value
     */
    setItem(key, value) {
        localStorage.setItem(key, value);
    }
    /**
     * common get item
     * @param {string} key
     */
    getItem(key) {
        return localStorage.getItem(key);
    }
    /**
     * common remove item
     * @param {string} key
     */
    removeItem(key) {
        localStorage.removeItem(key);
    }
    /**
     * set session-token
     * @param {string} value
     */
    setToken(value) {
        this._token = value;
        localStorage.setItem(KEYS.token, value);
    }
    /**
     *  get token
     * @param {string} key
     */
    static get token() {
        return localStorage.getItem(KEYS.token);
    }
    /**
     *  remove token
     * @param {string} key
     */
    removeToken() {
        localStorage.removeItem(KEYS.token);
        this._token = null;
    }
    /**
     *  set appVersion
     * @param {MsdaAppVersions} versions
     */
    setAppVersion(versions) {
        const current = Object.assign(Object.assign({}, this.versions), versions);
        localStorage.setItem(KEYS.appVersions, JSON.stringify(current));
        return this.versions;
    }
    /**
     *  get appVersions
     */
    get appVersions() {
        return this.versions;
    }
    _setSessionClient(clientId) {
        return this._httpClient.post(`${this._apiPrefix}/um/v3/user/session/client`, { data: { clientId } });
    }
    //translations
    _checkTranslationVersions() {
        return __awaiter(this, void 0, void 0, function* () {
            const versions = yield this._getRemoteTranslationVersions();
            if (versions) {
                const i18n = this._getLocalTranslationVersions();
                const appsTranslationsToUpdate = this._getOutDatedAppKeywords(versions, i18n);
                const updatedAppTranslations = yield this._getTranslations(appsTranslationsToUpdate);
                this._updateInStorage(updatedAppTranslations);
            }
        });
    }
    _getRemoteTranslationVersions() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { result: { data } } = yield this._httpClient.get(`${this._apiPrefix}/translations/versions`).toPromise();
                return data;
            }
            catch (err) {
                return null;
            }
        });
    }
    _getLocalTranslationVersions() {
        try {
            return JSON.parse(localStorage.getItem(KEYS.i18n) || '{}');
        }
        catch (error) {
            console.error(error);
            return {};
        }
    }
    _getOutDatedAppKeywords(versions, i18n) {
        const outDated = {};
        this.applicationAbbrs.forEach(abbr => {
            if (!i18n[abbr] || i18n[abbr].version < versions[abbr]) {
                outDated[abbr] = versions[abbr];
            }
        });
        return outDated;
    }
    _getTranslations(applications) {
        return __awaiter(this, void 0, void 0, function* () {
            const updatedTranslations = {};
            yield Promise.all(Object.keys(applications).map((application) => __awaiter(this, void 0, void 0, function* () {
                try {
                    const { result: { data } } = yield this._httpClient.post(`${this._apiPrefix}/translations`, { data: { applications: [application] } }).toPromise();
                    const keywords = this._transformTranslations(data);
                    updatedTranslations[application] = {
                        version: applications[application],
                        keywords: keywords
                    };
                }
                catch (err) {
                    console.error(err);
                }
            })));
            return updatedTranslations;
        });
    }
    _transformTranslations(translations) {
        const translationObject = {};
        translations.forEach(translation => {
            translationObject[translation.keyword] = translation.translations;
        });
        return translationObject;
    }
    _updateInStorage(newData) {
        try {
            const oldData = this._getLocalTranslationVersions();
            const toSave = Object.assign(Object.assign({}, oldData), newData);
            localStorage.setItem(KEYS.i18n, JSON.stringify(toSave));
        }
        catch (err) {
            console.log(err);
        }
    }
    get translations() {
        return this._getLocalTranslationVersions();
    }
    get versions() {
        try {
            return JSON.parse(localStorage.getItem(KEYS.appVersions) || '{}');
        }
        catch (error) {
            console.error(error);
            return {};
        }
    }
    /**
     * set config
     * @param {Config} config  set apiConfig
     */
    setConfig(config) {
        this._apiPrefix = config.apiPrefix;
    }
}
MsdaStorage.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: MsdaStorage, deps: [{ token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
MsdaStorage.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: MsdaStorage });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: MsdaStorage, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.HttpClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXNkYS1zdG9yYWdlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9tc2RhLXN0b3JhZ2Uvc3JjL2xpYi9tc2RhLXN0b3JhZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7O0FBRzNDLE1BQU0sSUFBSSxHQUFHO0lBQ1gsSUFBSSxFQUFFLE1BQU07SUFDWixLQUFLLEVBQUUsZUFBZTtJQUN0QixJQUFJLEVBQUUsTUFBTTtJQUNaLFFBQVEsRUFBRSxVQUFVO0lBQ3BCLFdBQVcsRUFBRSxhQUFhO0NBQzNCLENBQUE7QUFHRCxNQUFNLE9BQU8sV0FBVztJQUt0QixZQUFvQixXQUF1QjtRQUF2QixnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUozQyxxQkFBZ0IsR0FBYSxFQUFFLENBQUM7UUFFeEIsV0FBTSxHQUFtQixFQUFFLENBQUM7UUFDNUIsZUFBVSxHQUFXLE1BQU0sQ0FBQztJQUNXLENBQUM7SUFFaEQ7Ozs7T0FJRztJQUNHLGdCQUFnQixDQUFDLFdBQXFCOztZQUMxQyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFO2dCQUNyQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO2dCQUNwQyxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQzthQUNsQztRQUNILENBQUM7S0FBQTtJQUVEOzs7T0FHRztJQUNHLFdBQVcsQ0FBQyxRQUF1QixFQUFFLFlBQXNCOztZQUMvRCxJQUFJLFlBQVksRUFBRTtnQkFDaEIsSUFBSTtvQkFDRixNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztvQkFDbkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7aUJBQ2pEO2dCQUFDLE9BQU8sS0FB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RDtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFRCxJQUFXLFlBQVk7UUFDckIsT0FBTyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0lBR0QsSUFBVyxRQUFRO1FBQ2pCLElBQUk7WUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUE7U0FDbEU7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDckIsT0FBTyxFQUFFLENBQUE7U0FDVjtJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSSxTQUFTLENBQUMsTUFBYztRQUM3QixJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUE7SUFDcEMsQ0FBQzs7eUdBdFFVLFdBQVc7NkdBQVgsV0FBVzs0RkFBWCxXQUFXO2tCQUR2QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuXG5jb25zdCBLRVlTID0ge1xuICBpMThuOiAnaTE4bicsXG4gIHRva2VuOiAnc2Vzc2lvbi10b2tlbicsXG4gIGxhbmc6ICdsYW5nJyxcbiAgY2xpZW50SWQ6ICdjbGllbnRJZCcsXG4gIGFwcFZlcnNpb25zOiAnYXBwVmVyc2lvbnMnXG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNc2RhU3RvcmFnZSB7XG4gIGFwcGxpY2F0aW9uQWJicnM6IHN0cmluZ1tdID0gW107XG4gIHByaXZhdGUgX2NsaWVudElkPzogbnVtYmVyIHwgbnVsbDtcbiAgcHJpdmF0ZSBfdG9rZW4/OiBzdHJpbmcgfCBudWxsID0gJyc7XG4gIHByaXZhdGUgX2FwaVByZWZpeDogc3RyaW5nID0gJy9hcGknO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9odHRwQ2xpZW50OiBIdHRwQ2xpZW50KSB7IH1cblxuICAvKipcbiAgICogTG9hZCBUcmFuc2xhdGlvbnMgd2l0aCBBcHAgYWJicmV2aWF0aW9uc1xuICAgKiBAcGFyYW0ge1N0cmluZ30gYXBwS2V5d29yZHNbXVxuICAgKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4IG9wdGlvbmFsIHBhcmFtZXRlclxuICAgKi9cbiAgYXN5bmMgbG9hZFRyYW5zbGF0aW9ucyhhcHBLZXl3b3Jkczogc3RyaW5nW10pIHtcbiAgICBpZiAoYXBwS2V5d29yZHMgJiYgYXBwS2V5d29yZHMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmFwcGxpY2F0aW9uQWJicnMgPSBhcHBLZXl3b3JkcztcbiAgICAgIHRoaXMuX2NoZWNrVHJhbnNsYXRpb25WZXJzaW9ucygpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBzZXQgY2xpZW50SWQgdG8gc3RvcmFnZVxuICAgKiBAcGFyYW0ge251bWJlcn0gY2xpZW50SWRcbiAgICovXG4gIGFzeW5jIHNldENsaWVudElkKGNsaWVudElkOiBudW1iZXIgfCBudWxsLCBzZXRJblNlc3Npb24/OiBib29sZWFuKSB7XG4gICAgaWYgKHNldEluU2Vzc2lvbikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5fc2V0U2Vzc2lvbkNsaWVudChjbGllbnRJZCkudG9Qcm9taXNlKCk7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRoaXMuX3NldENsaWVudElkKGNsaWVudElkKSB9O1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yIH07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRoaXMuX3NldENsaWVudElkKGNsaWVudElkKSB9O1xuICB9XG5cbiAgZ2V0IGNsaWVudElkKCkge1xuICAgIHJldHVybiB0aGlzLl9nZXRDbGllbnRJZCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIHJlbW92ZSBjbGllbnRJZFxuICAgKiBAcGFyYW0ge251bWJlcn0gY2xpZW50SWRcbiAgICovXG4gIHB1YmxpYyByZW1vdmVDbGllbnRJZCgpIHtcbiAgICB0aGlzLnNldENsaWVudElkKG51bGwpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0Q2xpZW50SWQoY2xpZW50SWQ6IG51bWJlciB8IG51bGwpIHtcbiAgICB0aGlzLl9jbGllbnRJZCA9IGNsaWVudElkO1xuICAgIGlmIChjbGllbnRJZClcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEtFWVMuY2xpZW50SWQsIGNsaWVudElkLnRvU3RyaW5nKCkpO1xuICAgIGVsc2UgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oS0VZUy5jbGllbnRJZCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIF9nZXRDbGllbnRJZCgpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5fY2xpZW50SWQgPSBOdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZUy5jbGllbnRJZCkpO1xuICAgICAgcmV0dXJuIHRoaXMuX2NsaWVudElkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG5cbiAgLyoqXG4gICAqIHNldCBsYW5nIHRvIHN0b3JhZ2VcbiAgICogQHBhcmFtIHtzdHJpbmd9IGxhbmdcbiAgICovXG4gIHNldExhbmcobGFuZzogc3RyaW5nKSB7XG4gICAgdGhpcy5fc2V0TGFuZyhsYW5nKTtcbiAgfVxuICAvKipcbiAgICogIGdldCBsYW5nXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldCBsYW5nKCkge1xuICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLRVlTLmxhbmcpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0TGFuZyhsYW5nOiBzdHJpbmcgfCBudWxsKSB7XG4gICAgaWYgKGxhbmcpXG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLRVlTLmxhbmcsIGxhbmcpO1xuICAgIGVsc2UgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oS0VZUy5sYW5nKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldExhbmcoKSB7XG4gICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKEtFWVMubGFuZyk7XG4gIH1cblxuICAvKipcbiAgICogY29tbW9uIHNldCBpdGVtXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXlcbiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlXG4gICAqL1xuICBwdWJsaWMgc2V0SXRlbShrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgdmFsdWUpO1xuICB9XG4gIC8qKlxuICAgKiBjb21tb24gZ2V0IGl0ZW1cbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleVxuICAgKi9cbiAgcHVibGljIGdldEl0ZW0oa2V5OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTtcbiAgfVxuICAvKipcbiAgICogY29tbW9uIHJlbW92ZSBpdGVtXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXlcbiAgICovXG4gIHB1YmxpYyByZW1vdmVJdGVtKGtleTogc3RyaW5nKSB7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBzZXQgc2Vzc2lvbi10b2tlblxuICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWVcbiAgICovXG4gIHB1YmxpYyBzZXRUb2tlbih2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5fdG9rZW4gPSB2YWx1ZTtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLRVlTLnRva2VuLCB2YWx1ZSk7XG4gIH1cbiAgLyoqXG4gICAqICBnZXQgdG9rZW5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleVxuICAgKi9cbiAgc3RhdGljIGdldCB0b2tlbigpIHtcbiAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZUy50b2tlbik7XG4gIH1cbiAgLyoqXG4gICAqICByZW1vdmUgdG9rZW5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleVxuICAgKi9cbiAgcHVibGljIHJlbW92ZVRva2VuKCkge1xuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKEtFWVMudG9rZW4pO1xuICAgIHRoaXMuX3Rva2VuID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiAgc2V0IGFwcFZlcnNpb25cbiAgICogQHBhcmFtIHtNc2RhQXBwVmVyc2lvbnN9IHZlcnNpb25zXG4gICAqL1xuICBwdWJsaWMgc2V0QXBwVmVyc2lvbih2ZXJzaW9uczogTXNkYUFwcFZlcnNpb25zKSB7XG4gICAgY29uc3QgY3VycmVudCA9IHsgLi4udGhpcy52ZXJzaW9ucywgLi4udmVyc2lvbnMgfTtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLRVlTLmFwcFZlcnNpb25zLCBKU09OLnN0cmluZ2lmeShjdXJyZW50KSlcbiAgICByZXR1cm4gdGhpcy52ZXJzaW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiAgZ2V0IGFwcFZlcnNpb25zXG4gICAqL1xuICBnZXQgYXBwVmVyc2lvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMudmVyc2lvbnM7XG4gIH1cblxuICBwdWJsaWMgX3NldFNlc3Npb25DbGllbnQoY2xpZW50SWQ6IG51bWJlciB8IG51bGwpIHtcbiAgICByZXR1cm4gdGhpcy5faHR0cENsaWVudC5wb3N0PE1zZGFSZXNwb25zZTxhbnk+PihgJHt0aGlzLl9hcGlQcmVmaXh9L3VtL3YzL3VzZXIvc2Vzc2lvbi9jbGllbnRgLCB7IGRhdGE6IHsgY2xpZW50SWQgfSB9KTtcbiAgfVxuXG5cblxuXG4gIC8vdHJhbnNsYXRpb25zXG5cbiAgcHJpdmF0ZSBhc3luYyBfY2hlY2tUcmFuc2xhdGlvblZlcnNpb25zKCkge1xuICAgIGNvbnN0IHZlcnNpb25zID0gYXdhaXQgdGhpcy5fZ2V0UmVtb3RlVHJhbnNsYXRpb25WZXJzaW9ucygpO1xuICAgIGlmICh2ZXJzaW9ucykge1xuICAgICAgY29uc3QgaTE4biA9IHRoaXMuX2dldExvY2FsVHJhbnNsYXRpb25WZXJzaW9ucygpO1xuICAgICAgY29uc3QgYXBwc1RyYW5zbGF0aW9uc1RvVXBkYXRlOiBBcHBUcmFubGF0aW9uVmVyc2lvbiA9IHRoaXMuX2dldE91dERhdGVkQXBwS2V5d29yZHModmVyc2lvbnMsIGkxOG4pO1xuICAgICAgY29uc3QgdXBkYXRlZEFwcFRyYW5zbGF0aW9ucyA9IGF3YWl0IHRoaXMuX2dldFRyYW5zbGF0aW9ucyhhcHBzVHJhbnNsYXRpb25zVG9VcGRhdGUpO1xuICAgICAgdGhpcy5fdXBkYXRlSW5TdG9yYWdlKHVwZGF0ZWRBcHBUcmFuc2xhdGlvbnMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgX2dldFJlbW90ZVRyYW5zbGF0aW9uVmVyc2lvbnMoKTogUHJvbWlzZTxBcHBUcmFubGF0aW9uVmVyc2lvbiB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXN1bHQ6IHsgZGF0YSB9IH0gPSBhd2FpdCB0aGlzLl9odHRwQ2xpZW50LmdldDxNc2RhUmVzcG9uc2U8QXBwVHJhbmxhdGlvblZlcnNpb24+PihgJHt0aGlzLl9hcGlQcmVmaXh9L3RyYW5zbGF0aW9ucy92ZXJzaW9uc2ApLnRvUHJvbWlzZSgpO1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9nZXRMb2NhbFRyYW5zbGF0aW9uVmVyc2lvbnMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKEtFWVMuaTE4bikgfHwgJ3t9Jyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgcmV0dXJuIHt9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0T3V0RGF0ZWRBcHBLZXl3b3Jkcyh2ZXJzaW9uczogQXBwVHJhbmxhdGlvblZlcnNpb24sIGkxOG46IE1zZGFJMThuKTogQXBwVHJhbmxhdGlvblZlcnNpb24ge1xuICAgIGNvbnN0IG91dERhdGVkOiBBcHBUcmFubGF0aW9uVmVyc2lvbiA9IHt9O1xuICAgIHRoaXMuYXBwbGljYXRpb25BYmJycy5mb3JFYWNoKGFiYnIgPT4ge1xuICAgICAgaWYgKCFpMThuW2FiYnJdIHx8IGkxOG5bYWJicl0udmVyc2lvbiA8IHZlcnNpb25zW2FiYnJdKSB7XG4gICAgICAgIG91dERhdGVkW2FiYnJdID0gdmVyc2lvbnNbYWJicl1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBvdXREYXRlZDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgX2dldFRyYW5zbGF0aW9ucyhhcHBsaWNhdGlvbnM6IEFwcFRyYW5sYXRpb25WZXJzaW9uKTogUHJvbWlzZTxNc2RhSTE4bj4ge1xuICAgIGNvbnN0IHVwZGF0ZWRUcmFuc2xhdGlvbnM6IE1zZGFJMThuID0ge307XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoT2JqZWN0LmtleXMoYXBwbGljYXRpb25zKS5tYXAoYXN5bmMgYXBwbGljYXRpb24gPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyByZXN1bHQ6IHsgZGF0YSB9IH0gPSBhd2FpdCB0aGlzLl9odHRwQ2xpZW50LnBvc3Q8TXNkYVJlc3BvbnNlPE9yaWdpbmFsVHJhbnNsYXRpb25bXT4+KGAke3RoaXMuX2FwaVByZWZpeH0vdHJhbnNsYXRpb25zYCwgeyBkYXRhOiB7IGFwcGxpY2F0aW9uczogW2FwcGxpY2F0aW9uXSB9IH0pLnRvUHJvbWlzZSgpO1xuICAgICAgICBjb25zdCBrZXl3b3JkcyA9IHRoaXMuX3RyYW5zZm9ybVRyYW5zbGF0aW9ucyhkYXRhKTtcbiAgICAgICAgdXBkYXRlZFRyYW5zbGF0aW9uc1thcHBsaWNhdGlvbl0gPSB7XG4gICAgICAgICAgdmVyc2lvbjogYXBwbGljYXRpb25zW2FwcGxpY2F0aW9uXSxcbiAgICAgICAgICBrZXl3b3Jkczoga2V5d29yZHNcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgIH1cbiAgICB9KSk7XG4gICAgcmV0dXJuIHVwZGF0ZWRUcmFuc2xhdGlvbnM7XG4gIH1cblxuICBwcml2YXRlIF90cmFuc2Zvcm1UcmFuc2xhdGlvbnModHJhbnNsYXRpb25zOiBPcmlnaW5hbFRyYW5zbGF0aW9uW10pOiBUcmFuc2xhdGlvbnMge1xuICAgIGNvbnN0IHRyYW5zbGF0aW9uT2JqZWN0OiBUcmFuc2xhdGlvbnMgPSB7fTtcblxuICAgIHRyYW5zbGF0aW9ucy5mb3JFYWNoKHRyYW5zbGF0aW9uID0+IHtcbiAgICAgIHRyYW5zbGF0aW9uT2JqZWN0W3RyYW5zbGF0aW9uLmtleXdvcmRdID0gdHJhbnNsYXRpb24udHJhbnNsYXRpb25zO1xuICAgIH0pXG5cbiAgICByZXR1cm4gdHJhbnNsYXRpb25PYmplY3Q7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVJblN0b3JhZ2UobmV3RGF0YTogTXNkYUkxOG4pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb2xkRGF0YSA9IHRoaXMuX2dldExvY2FsVHJhbnNsYXRpb25WZXJzaW9ucygpO1xuICAgICAgY29uc3QgdG9TYXZlID0ge1xuICAgICAgICAuLi5vbGREYXRhLFxuICAgICAgICAuLi5uZXdEYXRhXG4gICAgICB9XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLRVlTLmkxOG4sIEpTT04uc3RyaW5naWZ5KHRvU2F2ZSkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRyYW5zbGF0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0TG9jYWxUcmFuc2xhdGlvblZlcnNpb25zKCk7XG4gIH1cblxuXG4gIHB1YmxpYyBnZXQgdmVyc2lvbnMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKEtFWVMuYXBwVmVyc2lvbnMpIHx8ICd7fScpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgcmV0dXJuIHt9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIHNldCBjb25maWdcbiAgICogQHBhcmFtIHtDb25maWd9IGNvbmZpZyAgc2V0IGFwaUNvbmZpZyBcbiAgICovXG4gIHB1YmxpYyBzZXRDb25maWcoY29uZmlnOiBDb25maWcpe1xuICAgIHRoaXMuX2FwaVByZWZpeCA9IGNvbmZpZy5hcGlQcmVmaXhcbiAgfVxufVxuXG5cblxuZXhwb3J0IGludGVyZmFjZSBDb25maWd7XG4gIGFwaVByZWZpeDpzdHJpbmc7XG59XG5leHBvcnQgaW50ZXJmYWNlIE1zZGFBcHBWZXJzaW9ucyB7XG4gIFt4OiBzdHJpbmddOiBNc2RhQXBwVmVyc2lvbkl0ZW1cbn1cblxuXG5leHBvcnQgaW50ZXJmYWNlIE1zZGFBcHBWZXJzaW9uSXRlbSB7XG4gIGJ1aWxkOiBudW1iZXIsXG4gIHZlcnNpb246IHN0cmluZ1xufVxuXG5cblxuZXhwb3J0IGludGVyZmFjZSBNc2RhUmVzcG9uc2U8VD4ge1xuICByZXN1bHQ6IHtcbiAgICBkYXRhOiBUXG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcHBUcmFubGF0aW9uVmVyc2lvbiB7XG4gIFt4OiBzdHJpbmddOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhbnNsYXRpb25zIHtcbiAgW3g6IHN0cmluZ106IHtcbiAgICBnZTogc3RyaW5nO1xuICAgIGVuOiBzdHJpbmc7XG4gIH07XG59XG5leHBvcnQgaW50ZXJmYWNlIE1zZGFJMThuIHtcbiAgW3g6IHN0cmluZ106IHtcbiAgICB2ZXJzaW9uOiBudW1iZXI7XG4gICAga2V5d29yZHM6IFRyYW5zbGF0aW9uc1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9yaWdpbmFsVHJhbnNsYXRpb24ge1xuICBrZXl3b3JkOiBzdHJpbmc7XG4gIHRyYW5zbGF0aW9uczoge1xuICAgIGdlOiBzdHJpbmc7XG4gICAgZW46IHN0cmluZztcbiAgfVxufVxuIl19